---
export interface Props {
  context?: string;
}

const { context = "Allgemein" } = Astro.props;

const FORMSPREE_ID = "xyzabc123"; 
---

<form
  action={`https://formspree.io/f/${FORMSPREE_ID}`}
  method="POST"
  class="card-b2b p-8"
  id="contact-form-b2b"
>
  <input type="hidden" name="lead_type" value="b2b" />
  <input type="hidden" name="b2b_page" value={context} />
  <input type="hidden" name="utm_source" />
  <input type="hidden" name="utm_medium" />
  <input type="hidden" name="utm_campaign" />
  <input type="hidden" name="utm_content" />
  <input type="hidden" name="utm_term" />

  <div style="display:none" aria-hidden="true">
    <label>Don't fill this out if you're human: <input type="text" name="_gotcha" tabindex="-1" /></label>
  </div>

  <h3 class="text-xl font-bold mb-6 text-ink">B2B Kooperationsanfrage</h3>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div>
      <label for="company" class="block text-sm font-medium text-ink-body mb-1">Firma *</label>
      <input 
        type="text" 
        id="company" 
        name="company" 
        required 
        autocomplete="organization"
        class="w-full px-4 py-3 rounded-lg border border-border focus:ring-2 focus:ring-accent focus:border-accent"
      />
    </div>
    
    <div>
      <label for="contact_person" class="block text-sm font-medium text-ink-body mb-1">Ansprechpartner *</label>
      <input 
        type="text" 
        id="contact_person" 
        name="contact_person" 
        required 
        autocomplete="name"
        class="w-full px-4 py-3 rounded-lg border border-border focus:ring-2 focus:ring-accent focus:border-accent"
      />
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div>
      <label for="email" class="block text-sm font-medium text-ink-body mb-1">E-Mail *</label>
      <input 
        type="email" 
        id="email" 
        name="email" 
        required 
        autocomplete="email"
        class="w-full px-4 py-3 rounded-lg border border-border focus:ring-2 focus:ring-accent focus:border-accent"
      />
    </div>
    
    <div>
      <label for="phone" class="block text-sm font-medium text-ink-body mb-1">Telefon *</label>
      <input 
        type="tel" 
        id="phone" 
        name="phone" 
        required 
        autocomplete="tel"
        class="w-full px-4 py-3 rounded-lg border border-border focus:ring-2 focus:ring-accent focus:border-accent"
      />
    </div>
  </div>

  <div class="mb-6">
    <label for="need" class="block text-sm font-medium text-ink-body mb-1">Bedarf</label>
    <select 
      id="need" 
      name="need" 
      class="w-full px-4 py-3 rounded-lg border border-border focus:ring-2 focus:ring-accent focus:border-accent bg-card"
    >
      <option value="einmalig">Einmaliger Auftrag</option>
      <option value="gelegentlich">Gelegentliche Zusammenarbeit</option>
      <option value="regelmaessig">Regelmäßige Partnerschaft</option>
    </select>
  </div>

  <div class="mb-6">
    <label for="message" class="block text-sm font-medium text-ink-body mb-1">Nachricht</label>
    <textarea 
      id="message" 
      name="message" 
      rows="4" 
      class="w-full px-4 py-3 rounded-lg border border-border focus:ring-2 focus:ring-accent focus:border-accent"
    ></textarea>
  </div>

  <div class="flex justify-end">
    <button
      type="submit"
      class="btn btn-b2b"
      data-event="lead_form_click"
      data-event-category="engagement"
    >
      Kooperationsanfrage senden
    </button>
  </div>

  <div id="form-status-b2b" class="mt-4 text-center hidden"></div>
</form>

<script>
  const form = document.getElementById('contact-form-b2b') as HTMLFormElement;
  const status = document.getElementById('form-status-b2b');

  if (form) {
    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const data = new FormData(form);
      const action = form.action;

      try {
        const response = await fetch(action, {
          method: form.method,
          body: data,
          headers: { 'Accept': 'application/json' }
        });

        if (response.ok) {
          window.dataLayer = window.dataLayer || [];
          window.dataLayer.push({
            event: 'generate_lead',
            event_category: 'conversion',
            currency: 'EUR',
            value: 300,
            lead_source: sessionStorage.getItem('utm_source') || 'organic',
            lead_type: 'b2b'
          });

          if (status) {
            status.innerHTML = "Vielen Dank! Ihre Kooperationsanfrage wurde erfolgreich gesendet.";
            status.classList.remove('hidden');
            status.classList.add('text-success-dark', 'font-medium', 'p-4', 'bg-success-light', 'rounded-lg');
          }
          form.reset();
        } else {
          if (status) {
            status.innerHTML = "Es gab ein Problem beim Senden des Formulars.";
            status.classList.remove('hidden');
            status.classList.add('text-error');
          }
        }
      } catch (error) {
        if (status) {
          status.innerHTML = "Es gab ein Problem beim Senden des Formulars.";
          status.classList.remove('hidden');
          status.classList.add('text-error');
        }
      }
    });
  }
</script>
