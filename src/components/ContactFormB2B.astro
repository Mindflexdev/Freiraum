---
export interface Props {
  context?: string;
}

const { context = "Allgemein" } = Astro.props;
---

<form
  class="card-b2b p-8"
  id="contact-form-b2b"
  data-context={context}
>
  {/* Honeypot field - hidden from users */}
  <div style="display:none" aria-hidden="true">
    <label>Don't fill this out if you're human: <input type="text" name="_gotcha" tabindex="-1" /></label>
  </div>

  <h3 class="text-xl font-bold mb-6 text-ink">B2B Kooperationsanfrage</h3>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div>
      <label for="company" class="block text-sm font-medium text-ink-body mb-1">Firma *</label>
      <input
        type="text"
        id="company"
        name="Firma"
        required
        autocomplete="organization"
        class="w-full px-4 py-3 rounded-lg border border-border focus:ring-2 focus:ring-accent focus:border-accent"
      />
    </div>

    <div>
      <label for="contact_person" class="block text-sm font-medium text-ink-body mb-1">Ansprechpartner *</label>
      <input
        type="text"
        id="contact_person"
        name="Ansprechpartner"
        required
        autocomplete="name"
        class="w-full px-4 py-3 rounded-lg border border-border focus:ring-2 focus:ring-accent focus:border-accent"
      />
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div>
      <label for="email-b2b" class="block text-sm font-medium text-ink-body mb-1">E-Mail *</label>
      <input
        type="email"
        id="email-b2b"
        name="E-Mail"
        required
        autocomplete="email"
        class="w-full px-4 py-3 rounded-lg border border-border focus:ring-2 focus:ring-accent focus:border-accent"
      />
    </div>

    <div>
      <label for="phone-b2b" class="block text-sm font-medium text-ink-body mb-1">Telefon *</label>
      <input
        type="tel"
        id="phone-b2b"
        name="Telefon"
        required
        autocomplete="tel"
        class="w-full px-4 py-3 rounded-lg border border-border focus:ring-2 focus:ring-accent focus:border-accent"
      />
    </div>
  </div>

  <div class="mb-6">
    <label for="need" class="block text-sm font-medium text-ink-body mb-1">Bedarf</label>
    <select
      id="need"
      name="Bedarf"
      class="w-full px-4 py-3 rounded-lg border border-border focus:ring-2 focus:ring-accent focus:border-accent bg-card"
    >
      <option value="Einmaliger Auftrag">Einmaliger Auftrag</option>
      <option value="Gelegentliche Zusammenarbeit">Gelegentliche Zusammenarbeit</option>
      <option value="Regelmäßige Partnerschaft">Regelmäßige Partnerschaft</option>
    </select>
  </div>

  <div class="mb-6">
    <label for="message-b2b" class="block text-sm font-medium text-ink-body mb-1">Nachricht</label>
    <textarea
      id="message-b2b"
      name="Nachricht"
      rows="4"
      class="w-full px-4 py-3 rounded-lg border border-border focus:ring-2 focus:ring-accent focus:border-accent"
    ></textarea>
  </div>

  <div class="mb-6">
    <label class="flex items-start gap-3 cursor-pointer">
      <input
        type="checkbox"
        name="datenschutz"
        required
        class="mt-1 w-4 h-4 rounded border-border text-accent focus:ring-accent flex-shrink-0"
      />
      <span class="text-sm text-ink-body">
        Ich habe die <a href="/datenschutz/" target="_blank" class="text-accent hover:underline">Datenschutzerklärung</a> gelesen und stimme der Verarbeitung meiner Daten zur Bearbeitung meiner Anfrage zu. *
      </span>
    </label>
  </div>

  <div class="flex justify-end">
    <button
      type="submit"
      class="btn btn-b2b"
      data-event="lead_form_click"
      data-event-category="engagement"
    >
      Kooperationsanfrage senden
    </button>
  </div>

  <div id="form-status-b2b" class="mt-4 text-center hidden"></div>
</form>

<script>
  const form = document.getElementById('contact-form-b2b') as HTMLFormElement;
  const status = document.getElementById('form-status-b2b');

  if (form) {
    form.addEventListener('submit', async (event) => {
      event.preventDefault();

      const formData = new FormData(form);
      const context = form.dataset.context || 'Allgemein';
      const payload: Record<string, string> = { _type: 'b2b', Seite: context };
      formData.forEach((value, key) => {
        if (key !== 'datenschutz') {
          payload[key] = value.toString();
        }
      });

      const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Wird gesendet…';
      }

      try {
        const response = await fetch('/api/contact', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (response.ok) {
          window.dataLayer = window.dataLayer || [];
          window.dataLayer.push({
            event: 'generate_lead',
            event_category: 'conversion',
            currency: 'EUR',
            value: 300,
            lead_source: sessionStorage.getItem('utm_source') || 'organic',
            lead_type: 'b2b',
          });

          if (status) {
            status.innerHTML = '✓ Vielen Dank! Ihre Kooperationsanfrage wurde gesendet. Sie erhalten in Kürze eine Bestätigung per E-Mail.';
            status.classList.remove('hidden', 'text-error');
            status.classList.add('text-success-dark', 'font-medium', 'p-4', 'bg-success-light', 'rounded-lg');
          }
          form.reset();
        } else {
          if (status) {
            status.innerHTML = 'Es gab ein Problem beim Senden. Bitte versuchen Sie es erneut oder rufen Sie uns an: 030 585 816 730';
            status.classList.remove('hidden', 'text-success-dark', 'bg-success-light');
            status.classList.add('text-error', 'p-4');
          }
        }
      } catch (error) {
        if (status) {
          status.innerHTML = 'Es gab ein Problem beim Senden. Bitte versuchen Sie es erneut oder rufen Sie uns an: 030 585 816 730';
          status.classList.remove('hidden', 'text-success-dark', 'bg-success-light');
          status.classList.add('text-error', 'p-4');
        }
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Kooperationsanfrage senden';
        }
      }
    });
  }
</script>
