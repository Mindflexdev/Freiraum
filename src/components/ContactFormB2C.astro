---
const FORMSPREE_ID = "xojnjogb"; 
---

<form 
  action={`https://formspree.io/f/${FORMSPREE_ID}`} 
  method="POST" 
  class="card p-6"
  id="contact-form-b2c"
>
  {/* Formspree: Betreffzeile + Reply-To aus E-Mail-Feld */}
  <input type="hidden" name="_subject" value="Neue Anfrage über freiraum-aufloesung.de (Privat)" />
  <input type="hidden" name="_replyto" id="replyto-b2c" />

  {/* Honeypot field - hidden from users */}
  <div style="display:none" aria-hidden="true">
    <label>Don't fill this out if you're human: <input type="text" name="_gotcha" tabindex="-1" /></label>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div>
      <label for="name" class="block text-sm font-medium text-ink-body mb-1">Name *</label>
      <input
        type="text"
        id="name"
        name="Name"
        required
        autocomplete="name"
        class="w-full px-4 py-3 rounded-lg border border-border focus:ring-2 focus:ring-accent focus:border-accent"
      />
    </div>
    
    <div>
      <label for="phone" class="block text-sm font-medium text-ink-body mb-1">Telefon *</label>
      <input
        type="tel"
        id="phone"
        name="Telefon"
        required
        autocomplete="tel"
        class="w-full px-4 py-3 rounded-lg border border-border focus:ring-2 focus:ring-accent focus:border-accent"
      />
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div>
      <label for="email" class="block text-sm font-medium text-ink-body mb-1">E-Mail</label>
      <input
        type="email"
        id="email"
        name="E-Mail"
        autocomplete="email"
        class="w-full px-4 py-3 rounded-lg border border-border focus:ring-2 focus:ring-accent focus:border-accent"
      />
    </div>
    
    <div>
      <label for="service" class="block text-sm font-medium text-ink-body mb-1">Anliegen</label>
      <select
        id="service"
        name="Anliegen"
        class="w-full px-4 py-3 rounded-lg border border-border focus:ring-2 focus:ring-accent focus:border-accent bg-card truncate"
      >
        <option value="">Bitte wählen</option>
        <option value="Wohnungsauflösung">Wohnung</option>
        <option value="Hausauflösung">Haus</option>
        <option value="Haushaltsauflösung">Haushalt</option>
        <option value="Entrümpelung">Entrümpelung</option>
        <option value="Gewerbeauflösung">Gewerbe</option>
        <option value="Sonstiges">Sonstiges</option>
      </select>
    </div>
  </div>

  <div class="mb-6">
    <label for="message" class="block text-sm font-medium text-ink-body mb-1">Nachricht</label>
    <textarea
      id="message"
      name="Nachricht"
      rows="4"
      class="w-full px-4 py-3 rounded-lg border border-border focus:ring-2 focus:ring-accent focus:border-accent"
    ></textarea>
  </div>

  <div class="mb-6">
    <label class="flex items-start gap-3 cursor-pointer">
      <input
        type="checkbox"
        name="datenschutz"
        required
        class="mt-1 w-4 h-4 rounded border-border text-accent focus:ring-accent flex-shrink-0"
      />
      <span class="text-sm text-ink-body">
        Ich habe die <a href="/datenschutz/" target="_blank" class="text-accent hover:underline">Datenschutzerklärung</a> gelesen und stimme der Verarbeitung meiner Daten zur Bearbeitung meiner Anfrage zu. *
      </span>
    </label>
  </div>

  <div class="flex flex-col items-center">
    <button
      type="submit"
      class="btn btn-primary w-full md:w-auto"
      data-event="lead_form_click"
      data-event-category="engagement"
    >
      Kostenloses Angebot anfordern
    </button>
    <p class="text-sm text-ink-light mt-4 text-center">
      <svg class="w-4 h-4 inline-block mr-0.5 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>Kostenlos & unverbindlich · Antwort innerhalb von 24 Stunden
    </p>
  </div>
  
  <div id="form-status" class="mt-4 text-center hidden"></div>
</form>

<script>
  // Simple form handling script for inline success message
  const form = document.getElementById('contact-form-b2c') as HTMLFormElement;
  const status = document.getElementById('form-status');

  // Sync _replyto mit E-Mail-Feld
  const emailField = document.getElementById('email') as HTMLInputElement;
  const replyToField = document.getElementById('replyto-b2c') as HTMLInputElement;
  if (emailField && replyToField) {
    emailField.addEventListener('input', () => { replyToField.value = emailField.value; });
  }

  if (form) {
    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const data = new FormData(form);
      data.delete('datenschutz');
      const action = form.action;
      
      try {
        const response = await fetch(action, {
          method: form.method,
          body: data,
          headers: {
              'Accept': 'application/json'
          }
        });
        
        if (response.ok) {
          // Track successful form submission
          window.dataLayer = window.dataLayer || [];
          window.dataLayer.push({
            event: 'generate_lead',
            event_category: 'conversion',
            currency: 'EUR',
            value: 150,
            lead_source: sessionStorage.getItem('utm_source') || 'organic',
            lead_type: 'b2c'
          });

          if (status) {
            status.innerHTML = "Vielen Dank! Ihre Anfrage wurde erfolgreich gesendet.";
            status.classList.remove('hidden');
            status.classList.add('text-success-dark', 'font-medium', 'p-4', 'bg-success-light', 'rounded-lg');
          }
          form.reset();
        } else {
          const data = await response.json();
          if (Object.hasOwn(data, 'errors')) {
            if (status) {
              status.innerHTML = data["errors"].map((error: { message: string }) => error["message"]).join(", ");
              status.classList.remove('hidden');
              status.classList.add('text-error');
            }
          } else {
             if (status) {
                status.innerHTML = "Es gab ein Problem beim Senden des Formulars.";
                status.classList.remove('hidden');
                status.classList.add('text-error');
             }
          }
        }
      } catch (error) {
        if (status) {
          status.innerHTML = "Es gab ein Problem beim Senden des Formulars.";
          status.classList.remove('hidden');
          status.classList.add('text-error');
        }
      }
    });

  }
</script>
