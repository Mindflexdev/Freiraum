---
// CookieBanner.astro — Lightweight DSGVO cookie consent (<5 KB)
// No external tools (Cookiebot, OneTrust etc.)
// GTM loads ONLY after consent
---

<div id="cookie-banner" class="fixed bottom-0 left-0 right-0 z-[9999] hidden" role="dialog" aria-label="Cookie-Einstellungen">
  <div class="bg-card border-t border-border shadow-modal px-4 py-4 md:px-6 pb-[calc(1rem+env(safe-area-inset-bottom))]">
    <div class="max-w-5xl mx-auto flex flex-col sm:flex-row items-center gap-4">
      <p class="text-sm text-ink-body flex-1 m-0">
        Wir nutzen Cookies zur Analyse und Verbesserung unserer Website.
        <a href="/datenschutz/" class="underline text-ink hover:text-accent">Mehr erfahren</a>
      </p>
      <div class="flex gap-3 shrink-0">
        <button
          id="cookie-reject"
          type="button"
          class="px-5 py-2.5 text-sm font-semibold rounded-lg border border-border bg-card text-ink hover:bg-bg transition-colors min-h-[48px] min-w-[160px]"
        >
          Nur notwendige
        </button>
        <button
          id="cookie-accept"
          type="button"
          class="px-5 py-2.5 text-sm font-semibold rounded-lg border border-border bg-card text-ink hover:bg-bg transition-colors min-h-[48px] min-w-[160px]"
        >
          Akzeptieren
        </button>
      </div>
    </div>
  </div>
</div>

<script is:inline>
(function() {
  // Check existing consent
  var match = document.cookie.match(/(?:^|;\s*)cookie_consent=([^;]*)/);
  var consent = match ? match[1] : null;

  if (consent === 'accepted') {
    loadGTM();
    return;
  }

  if (consent === 'rejected') {
    return;
  }

  // No decision yet — show banner
  var banner = document.getElementById('cookie-banner');
  if (banner) {
    banner.classList.remove('hidden');
    // Push StickyMobileCTA above banner
    adjustStickyCTA(true);
  }

  var acceptBtn = document.getElementById('cookie-accept');
  var rejectBtn = document.getElementById('cookie-reject');

  if (acceptBtn) {
    acceptBtn.addEventListener('click', function() {
      setConsent('accepted');
      hideBanner();
      loadGTM();
    });
  }

  if (rejectBtn) {
    rejectBtn.addEventListener('click', function() {
      setConsent('rejected');
      hideBanner();
    });
  }

  function setConsent(value) {
    var d = new Date();
    d.setTime(d.getTime() + 365 * 24 * 60 * 60 * 1000);
    document.cookie = 'cookie_consent=' + value + ';expires=' + d.toUTCString() + ';path=/;SameSite=Lax';
  }

  function hideBanner() {
    var b = document.getElementById('cookie-banner');
    if (b) b.classList.add('hidden');
    adjustStickyCTA(false);
  }

  function adjustStickyCTA(bannerVisible) {
    var cta = document.querySelector('.sticky-mobile-cta');
    if (!cta) return;
    if (bannerVisible) {
      var banner = document.getElementById('cookie-banner');
      if (banner) {
        cta.style.bottom = banner.offsetHeight + 'px';
      }
    } else {
      cta.style.bottom = '0';
    }
  }

  function loadGTM() {
    if (window.gtmLoaded) return;
    window.gtmLoaded = true;
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });
    var s = document.createElement('script');
    s.async = true;
    s.src = 'https://www.googletagmanager.com/gtm.js?id=GTM-NV79KL7Z';
    document.head.appendChild(s);
  }
})();
</script>
