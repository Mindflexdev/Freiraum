---
interface Props {
  title: string;
  description: string;
  canonical?: string;
  robots?: string;
  ogImage?: string;
  ogType?: string;
  schemas?: object[];
  pageType?: string;
  serviceCategory?: string;
  silo?: string;
  targetArea?: string;
  showStickyCTA?: boolean;
  geoRegion?: string;
  geoPlacename?: string;
}

const {
  title,
  description,
  canonical,
  robots = "index, follow",
  ogImage = "https://freiraum-aufloesung.de/images/og-image.jpg",
  ogType = "website",
  schemas,
  pageType = "generic",
  serviceCategory = "privat",
  silo = "generic",
  targetArea = "Berlin",
  showStickyCTA = true,
  geoRegion = "DE-BE",
  geoPlacename = "Berlin",
} = Astro.props;

import '../styles/global.css';

// Canonical: immer HTTPS + Trailing Slash
function ensureTrailingSlash(url: string): string {
  return url.endsWith('/') ? url : url + '/';
}
const baseCanonical = canonical || new URL(Astro.url.pathname, Astro.site).toString();
const canonicalURL = ensureTrailingSlash(baseCanonical);

// Schema: kombiniere alle Schemas in ein @graph
const schemaOutput = schemas && schemas.length > 0
  ? JSON.stringify({
      '@context': 'https://schema.org',
      '@graph': schemas.map(({ '@context': _, ...rest }: Record<string, unknown>) => rest),
    })
  : null;

import Header from '../components/Header.astro';
import TrustBar from '../components/TrustBar.astro';
import Footer from '../components/Footer.astro';
import StickyMobileCTA from '../components/StickyMobileCTA.astro';
import CookieBanner from '../components/CookieBanner.astro';
---

<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

    <!-- SEO Meta -->
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />
    <meta name="robots" content={robots} />

    <!-- Favicon -->
    <link rel="icon" href="/favicon.ico" sizes="32x32" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:locale" content="de_DE" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:type" content={ogType} />

    <!-- Geo Meta -->
    <meta name="geo.region" content={geoRegion} />
    <meta name="geo.placename" content={geoPlacename} />
    <meta name="geo.position" content="52.520008;13.404954" />
    <meta name="ICBM" content="52.520008, 13.404954" />

    <!-- Font: Plus Jakarta Sans (via Google Fonts in global.css) -->

    <!-- Data Layer Initialization -->
    <script is:inline define:vars={{ pageType, serviceCategory, silo, targetArea }}>
      window.dataLayer = window.dataLayer || [];
      window.dataLayer.push({
        page_type: pageType,
        service_category: serviceCategory,
        silo: silo,
        target_area: targetArea,
      });
    </script>

    <!-- Schema JSON-LD -->
    {schemaOutput && (
      <script type="application/ld+json" set:html={schemaOutput} />
    )}

    <!-- Styles kommen aus global.css via Import -->
  </head>
  <body class="bg-bg text-ink-body font-sans antialiased flex flex-col min-h-screen">
    <TrustBar />
    <Header />
    <main id="main" class={`flex-grow ${showStickyCTA ? 'pb-14 md:pb-0' : ''}`}>
      <slot />
    </main>
    <Footer />
    <StickyMobileCTA show={showStickyCTA} />
    <CookieBanner />

    <!-- Event Tracking: data-event Attribute → dataLayer -->
    <script is:inline>
    (function() {
      document.addEventListener('click', function(e) {
        var el = e.target.closest('[data-event]');
        if (!el) return;
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({
          event: el.getAttribute('data-event'),
          event_category: el.getAttribute('data-event-category') || 'engagement',
          event_label: el.getAttribute('data-event-label') || el.textContent.trim().substring(0, 50),
          link_url: el.href || ''
        });
      });

      // FAQ interaction tracking
      document.addEventListener('toggle', function(e) {
        if (e.target.tagName === 'DETAILS' && e.target.open) {
          var summary = e.target.querySelector('summary');
          window.dataLayer = window.dataLayer || [];
          window.dataLayer.push({
            event: 'faq_interaction',
            event_category: 'engagement',
            event_label: summary ? summary.textContent.trim().substring(0, 80) : ''
          });
        }
      }, true);
    })();
    </script>

    <!-- UTM Parameter Handling: URL → sessionStorage → Hidden Fields -->
    <script is:inline>
    (function() {
      var params = new URLSearchParams(window.location.search);
      var utmKeys = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_content', 'utm_term'];

      // Store UTM params from URL into sessionStorage
      var hasUtm = false;
      utmKeys.forEach(function(key) {
        var val = params.get(key);
        if (val) {
          sessionStorage.setItem(key, val);
          hasUtm = true;
        }
      });

      // Fill hidden UTM fields in all forms
      function fillUtmFields() {
        utmKeys.forEach(function(key) {
          var val = sessionStorage.getItem(key);
          if (val) {
            var fields = document.querySelectorAll('input[name="' + key + '"]');
            fields.forEach(function(field) { field.value = val; });
          }
        });
      }

      // Fill on load and on any dynamic form insertion
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fillUtmFields);
      } else {
        fillUtmFields();
      }
    })();
    </script>
  </body>
</html>
