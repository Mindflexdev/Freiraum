---
interface Props {
  title: string;
  description: string;
  canonical?: string;
  robots?: string;
  ogImage?: string;
  schemas?: object[];
  pageType?: string;
  serviceCategory?: string;
  silo?: string;
  targetArea?: string;
  showStickyCTA?: boolean;
}

const {
  title,
  description,
  canonical,
  robots = "index, follow",
  ogImage = "https://freiraum-aufloesung.de/images/og-image.jpg",
  schemas,
  pageType = "generic",
  serviceCategory = "privat",
  silo = "generic",
  targetArea = "Berlin",
  showStickyCTA = true,
} = Astro.props;

// Canonical: immer HTTPS + Trailing Slash
function ensureTrailingSlash(url: string): string {
  return url.endsWith('/') ? url : url + '/';
}
const baseCanonical = canonical || new URL(Astro.url.pathname, Astro.site).toString();
const canonicalURL = ensureTrailingSlash(baseCanonical);

// Schema: kombiniere alle Schemas in ein @graph
const schemaOutput = schemas && schemas.length > 0
  ? JSON.stringify({
      '@context': 'https://schema.org',
      '@graph': schemas.map(({ '@context': _, ...rest }: any) => rest),
    })
  : null;

import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import StickyMobileCTA from '../components/StickyMobileCTA.astro';
import CookieBanner from '../components/CookieBanner.astro';
---

<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- SEO Meta -->
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />
    <meta name="robots" content={robots} />

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:locale" content="de_DE" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:type" content="website" />

    <!-- Geo Meta -->
    <meta name="geo.region" content="DE-BE" />
    <meta name="geo.placename" content="Berlin" />
    <meta name="geo.position" content="52.520008;13.404954" />
    <meta name="ICBM" content="52.520008, 13.404954" />

    <!-- Font Preload — Inter (lokal, DSGVO-konform) -->
    <link rel="preload" href="/fonts/inter-latin.woff2" as="font" type="font/woff2" crossorigin />
    <link rel="preload" href="/fonts/inter-latin-ext.woff2" as="font" type="font/woff2" crossorigin />

    <!-- Data Layer Initialization -->
    <script is:inline define:vars={{ pageType, serviceCategory, silo, targetArea }}>
      window.dataLayer = window.dataLayer || [];
      window.dataLayer.push({
        page_type: pageType,
        service_category: serviceCategory,
        silo: silo,
        target_area: targetArea,
      });
    </script>

    <!-- Schema JSON-LD -->
    {schemaOutput && (
      <script type="application/ld+json" set:html={schemaOutput} />
    )}

    <!-- Critical CSS / Styles -->
    <style is:global>
      /* Inter — lokal gehostet, DSGVO-konform */
      @font-face {
        font-family: 'Inter';
        font-style: normal;
        font-weight: 100 900;
        font-display: swap;
        src: url('/fonts/inter-latin-ext.woff2') format('woff2');
        unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
      }
      @font-face {
        font-family: 'Inter';
        font-style: normal;
        font-weight: 100 900;
        font-display: swap;
        src: url('/fonts/inter-latin.woff2') format('woff2');
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
      }

      /* Base styles */
      :root {
        --color-primary: #1a56db;
        --color-secondary: #ea580c;
        --color-text-primary: #1f2937;
        --color-bg-alt: #f9fafb;
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-900 font-sans antialiased flex flex-col min-h-screen">
    <Header />
    <main id="main" class={`flex-grow ${showStickyCTA ? 'pb-14 md:pb-0' : ''}`}>
      <slot />
    </main>
    <Footer />
    <StickyMobileCTA show={showStickyCTA} />
    <CookieBanner />

    <!-- Event Tracking: data-event Attribute → dataLayer -->
    <script is:inline>
    (function() {
      document.addEventListener('click', function(e) {
        var el = e.target.closest('[data-event]');
        if (!el) return;
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({
          event: el.getAttribute('data-event'),
          event_category: el.getAttribute('data-event-category') || 'engagement',
          event_label: el.getAttribute('data-event-label') || el.textContent.trim().substring(0, 50),
          link_url: el.href || ''
        });
      });

      // FAQ interaction tracking
      document.addEventListener('toggle', function(e) {
        if (e.target.tagName === 'DETAILS' && e.target.open) {
          var summary = e.target.querySelector('summary');
          window.dataLayer = window.dataLayer || [];
          window.dataLayer.push({
            event: 'faq_interaction',
            event_category: 'engagement',
            event_label: summary ? summary.textContent.trim().substring(0, 80) : ''
          });
        }
      }, true);
    })();
    </script>

    <!-- UTM Parameter Handling: URL → sessionStorage → Hidden Fields -->
    <script is:inline>
    (function() {
      var params = new URLSearchParams(window.location.search);
      var utmKeys = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_content', 'utm_term'];

      // Store UTM params from URL into sessionStorage
      var hasUtm = false;
      utmKeys.forEach(function(key) {
        var val = params.get(key);
        if (val) {
          sessionStorage.setItem(key, val);
          hasUtm = true;
        }
      });

      // Fill hidden UTM fields in all forms
      function fillUtmFields() {
        utmKeys.forEach(function(key) {
          var val = sessionStorage.getItem(key);
          if (val) {
            var fields = document.querySelectorAll('input[name="' + key + '"]');
            fields.forEach(function(field) { field.value = val; });
          }
        });
      }

      // Fill on load and on any dynamic form insertion
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fillUtmFields);
      } else {
        fillUtmFields();
      }
    })();
    </script>
  </body>
</html>
