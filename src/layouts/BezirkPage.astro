---
import BaseLayout from './BaseLayout.astro';
import HeroCTA from '../components/HeroCTA.astro';
import AIReadyIntro from '../components/AIReadyIntro.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import InlineCTA from '../components/InlineCTA.astro';
import TrustBadges from '../components/TrustBadges.astro';
import FAQAccordion from '../components/FAQAccordion.astro';
import EndCTA from '../components/EndCTA.astro';
import GoogleReviews from '../components/GoogleReviews.astro';
import {
  buildLocalBusinessSchema,
  buildBreadcrumbSchema,
  buildFAQSchema,
} from '../utils/schema';

const { frontmatter } = Astro.props;
const {
  title,
  description,
  heroImage,
  heroTitle,
  heroSubline,
  introText,
  faq,
  ortsname,
  isHub,
  isBrandenburg,
  areaServedArray,
} = frontmatter || Astro.props;

const targetArea = ortsname || "Berlin";

// ACHTUNG: Potsdam + Kleinmachnow → areaServed NICHT Berlin!
// Hub-Seiten können ein Array übergeben (z.B. Brandenburg-Hub: [Potsdam, Kleinmachnow, Potsdam-Mittelmark])
const areaServed = areaServedArray
  ? areaServedArray
  : isBrandenburg ? targetArea : "Berlin";

// Hub-Zuordnung für Spoke-Breadcrumbs (Home → Hub → Spoke)
const hubMap: Record<string, { name: string; url: string }> = {
  'Charlottenburg': { name: 'Charlottenburg-Wilmersdorf', url: '/berlin-charlottenburg-wilmersdorf/' },
  'Grunewald': { name: 'Charlottenburg-Wilmersdorf', url: '/berlin-charlottenburg-wilmersdorf/' },
  'Schmargendorf': { name: 'Charlottenburg-Wilmersdorf', url: '/berlin-charlottenburg-wilmersdorf/' },
  'Zehlendorf': { name: 'Steglitz-Zehlendorf', url: '/berlin-steglitz-zehlendorf/' },
  'Dahlem': { name: 'Steglitz-Zehlendorf', url: '/berlin-steglitz-zehlendorf/' },
  'Potsdam': { name: 'Potsdam & Umland', url: '/brandenburg-potsdam-umland/' },
  'Kleinmachnow': { name: 'Potsdam & Umland', url: '/brandenburg-potsdam-umland/' },
};

const parentHub = !isHub && ortsname ? hubMap[ortsname] : null;

// Schema: LocalBusiness (mit korrektem areaServed) + Breadcrumb (+ optional FAQ)
const breadcrumbItems = parentHub
  ? [
      { name: 'Home', url: '/' },
      { name: parentHub.name, url: parentHub.url },
      { name: targetArea, url: Astro.url.pathname },
    ]
  : [
      { name: 'Home', url: '/' },
      { name: targetArea, url: Astro.url.pathname },
    ];

const schemas: object[] = [
  buildLocalBusinessSchema({ areaServed }),
  buildBreadcrumbSchema(breadcrumbItems),
];

if (faq && faq.length > 0) {
  schemas.push(buildFAQSchema(faq));
}
---

<BaseLayout
  title={title}
  description={description}
  schemas={schemas}
  pageType="bezirk"
  serviceCategory="privat"
  silo={isHub ? "bezirk-hub" : "bezirk-spoke"}
  targetArea={targetArea}
  showStickyCTA={true}
  geoRegion={isBrandenburg ? "DE-BB" : "DE-BE"}
  geoPlacename={isBrandenburg ? targetArea : "Berlin"}
>
  <Breadcrumbs items={breadcrumbItems} />

  <HeroCTA
    title={heroTitle}
    subline={heroSubline}
    image={heroImage}
    imageAlt={`Wohnungsauflösung ${targetArea} – Team von Freiraum-Auflösungen`}
    primaryBtnText={`Angebot für ${targetArea} anfordern`}
    secondaryBtnText="Kostenlose Besichtigung"
  />

  <AIReadyIntro>
    <p>{introText}</p>
  </AIReadyIntro>

  <section class="container-content py-8 max-w-4xl mx-auto prose prose-lg">
    <slot />
  </section>

  <InlineCTA
    title={`Wohnungsauflösung in ${targetArea} nötig?`}
    btnText="Jetzt Besichtigung vereinbaren"
  />

  <TrustBadges />

  <section class="container-content py-12 max-w-4xl mx-auto">
    <slot name="more-content" />
  </section>

  {faq && (
    <section class="container-content py-12 max-w-3xl mx-auto">
      <h2 class="text-ink mb-8 text-center">Häufige Fragen zu {targetArea}</h2>
      <FAQAccordion items={faq} />
    </section>
  )}

  <GoogleReviews headline="Das sagen unsere Kunden" maxReviews={3} variant="alt" />

  <EndCTA
    title={`Ihr Partner für ${targetArea}`}
    subtitle="Schnell, sauber und zum Festpreis."
  />
</BaseLayout>
